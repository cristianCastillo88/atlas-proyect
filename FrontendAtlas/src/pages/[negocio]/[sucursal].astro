---
import {
  getSucursalPublicaOptimizada,
  type SucursalPublica,
} from "../../services/public";
import Layout from "../../layouts/Layout.astro";
import SucursalPublicView from "../../components/public/SucursalPublicView";
import { Toaster } from "../../components/ui/Toaster";

export const prerender = false;

const { negocio, sucursal: sucursalParam } = Astro.params;

if (!negocio || !sucursalParam) {
  return Astro.redirect("/404");
}

const negocioSlug = negocio.toLowerCase();
const sucursalSlug = sucursalParam.toLowerCase();

let sucursal: SucursalPublica;

try {
  // 1. Intentar slug directo (tal cual viene en la URL)
  // Esto permite slugs personalizados como "centro" sin prefijo
  sucursal = await getSucursalPublicaOptimizada(sucursalSlug);
} catch (error) {
  // 2. Fallback: Intentar con prefijo negocio- (convención legacy)
  const slugCompuesto = `${negocioSlug}-${sucursalSlug}`;
  try {
    sucursal = await getSucursalPublicaOptimizada(slugCompuesto);
  } catch (err2) {
    console.error(
      `Sucursal no encontrada: ${sucursalSlug} ni ${slugCompuesto}`,
    );
    return Astro.redirect(`/${negocioSlug}`);
  }
}

// Validación de seguridad: Asegurar que la sucursal pertenece al negocio de la URL
if (sucursal.negocioSlug.toLowerCase() !== negocioSlug) {
  console.warn(
    `Mismatch de negocio: URL=${negocioSlug}, Sucursal=${sucursal.negocioSlug}`,
  );
  // Redirigir a 404 o al negocio correcto (por seguridad, mejor 404 para no revelar info)
  return Astro.redirect("/404");
}
---

<Layout title={`${sucursal.nombre} - Atlas`}>
  <SucursalPublicView client:load sucursal={sucursal} />
  <Toaster client:load />
</Layout>
