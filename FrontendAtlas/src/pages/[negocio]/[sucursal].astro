---
import {
  getSucursalPublicaOptimizada,
  type SucursalPublica,
} from "../../services/public";
import Layout from "../../layouts/Layout.astro";
import SucursalPublicView from "../../components/public/SucursalPublicView";
import { Toaster } from "../../components/ui/Toaster";

export const prerender = false;

const { negocio, sucursal: sucursalParam } = Astro.params;

if (!negocio || !sucursalParam) {
  return Astro.redirect("/404");
}

const negocioSlug = negocio.toLowerCase();
const sucursalSlug = sucursalParam.toLowerCase();
const slugCompleto = `${negocioSlug}-${sucursalSlug}`;

let sucursal: SucursalPublica;
try {
  // Using optimized fetch: parallel loading of static (cached) + dynamic (fresh) data
  sucursal = await getSucursalPublicaOptimizada(slugCompleto);
} catch (error) {
  console.error(`Sucursal no encontrada: ${slugCompleto}`, error);
  return Astro.redirect(`/${negocioSlug}`);
}
---

<Layout title={`${sucursal.nombre} - Atlas`}>
  <SucursalPublicView client:load sucursal={sucursal} />
  <Toaster client:load />
</Layout>
