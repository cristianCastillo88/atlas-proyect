---
import type { MetodoPago, TipoEntrega } from '../services/public';

interface Props {
  metodosPago: MetodoPago[];
  tiposEntrega: TipoEntrega[];
  sucursalTelefono: string;
  sucursalNombre: string;
}

const { metodosPago, tiposEntrega, sucursalTelefono, sucursalNombre } = Astro.props;
---

<!-- Bot√≥n Flotante del Carrito -->
<button
  id="cart-toggle"
  class="fixed bottom-6 right-6 w-16 h-16 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-lg flex items-center justify-center z-40 transition-transform hover:scale-110"
>
  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
  </svg>
  <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center hidden">0</span>
</button>

<!-- Drawer del Carrito -->
<div id="cart-drawer" class="fixed inset-0 z-50 hidden" data-telefono={sucursalTelefono} data-nombre={sucursalNombre}>
  <!-- Overlay -->
  <div id="cart-overlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  
  <!-- Panel del Carrito -->
  <div class="absolute right-0 top-0 h-full w-full md:w-[480px] bg-white shadow-2xl flex flex-col">
    <!-- Header -->
    <div class="bg-green-600 text-white p-4 flex items-center justify-between">
      <h2 class="text-xl font-bold">Tu Pedido</h2>
      <button id="close-cart" class="text-white hover:text-gray-200 text-2xl">‚úï</button>
    </div>

    <!-- Contenido Scrollable -->
    <div class="flex-1 overflow-y-auto p-4">
      <!-- Lista de Items -->
      <div id="cart-items" class="space-y-3 mb-6">
        <p class="text-gray-500 text-center py-8">Tu carrito est√° vac√≠o</p>
      </div>

      <!-- Total -->
      <div class="border-t pt-4 mb-6">
        <div class="flex justify-between items-center text-xl font-bold">
          <span>Total:</span>
          <span id="cart-total" class="text-green-600">$0.00</span>
        </div>
      </div>

      <!-- Formulario de Checkout -->
      <form id="checkout-form" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Nombre</label>
          <input
            type="text"
            name="nombre"
            required
            placeholder="Tu nombre completo"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Tel√©fono</label>
          <input
            type="tel"
            name="telefono"
            required
            placeholder="11 1234-5678"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Tipo de Entrega</label>
          <select
            id="tipo-entrega-select"
            name="tipoEntrega"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          >
            <option value="">Seleccionar...</option>
            {tiposEntrega.map(tipo => (
              <option value={tipo.id} data-nombre={tipo.nombre}>{tipo.nombre}</option>
            ))}
          </select>
        </div>

        <div id="direccion-container" class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-1">Direcci√≥n</label>
          <input
            type="text"
            name="direccion"
            placeholder="Calle, n√∫mero, piso, depto"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">M√©todo de Pago</label>
          <select
            name="metodoPago"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          >
            <option value="">Seleccionar...</option>
            {metodosPago.map(metodo => (
              <option value={metodo.id}>{metodo.nombre}</option>
            ))}
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Observaciones</label>
          <textarea
            name="observaciones"
            rows="2"
            placeholder="Ej: Sin cebolla, bien cocido, etc."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          ></textarea>
        </div>

        <button
          type="submit"
          id="btn-confirmar-pedido"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-colors"
        >
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
          </svg>
          Pedir por WhatsApp
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  import { $cart, $cantidadTotal, $precioTotal, restarItem, agregarItem, eliminarItem, limpiarCarrito } from '../store/cart';
  import { crearPedidoPublico } from '../services/public';

  const cartToggle = document.getElementById('cart-toggle');
  const cartDrawer = document.getElementById('cart-drawer');
  const cartOverlay = document.getElementById('cart-overlay');
  const closeCart = document.getElementById('close-cart');
  const cartBadge = document.getElementById('cart-badge');
  const cartItems = document.getElementById('cart-items');
  const cartTotal = document.getElementById('cart-total');
  const checkoutForm = document.getElementById('checkout-form') as HTMLFormElement;
  const tipoEntregaSelect = checkoutForm?.querySelector('[name="tipoEntrega"]');
  const direccionContainer = document.getElementById('direccion-container');

  // Obtener datos de la sucursal desde atributos data
  const sucursalTelefono = cartDrawer?.getAttribute('data-telefono') || '';
  const sucursalNombre = cartDrawer?.getAttribute('data-nombre') || '';

  // Abrir/Cerrar drawer
  function openDrawer() {
    cartDrawer?.classList.remove('hidden');
  }

  function closeDrawer() {
    cartDrawer?.classList.add('hidden');
  }

  cartToggle?.addEventListener('click', openDrawer);
  closeCart?.addEventListener('click', closeDrawer);
  cartOverlay?.addEventListener('click', closeDrawer);

  // Mostrar/ocultar campo direcci√≥n seg√∫n tipo de entrega
  tipoEntregaSelect?.addEventListener('change', (e) => {
    const select = e.target as HTMLSelectElement;
    const selectedOption = select.options[select.selectedIndex];
    const tipoNombre = selectedOption?.getAttribute('data-nombre')?.toLowerCase() || '';
    const direccionInput = checkoutForm?.querySelector('[name="direccion"]') as HTMLInputElement;
    
    // Si el tipo de entrega contiene "delivery" o "env√≠o", mostrar direcci√≥n
    if (tipoNombre.includes('delivery') || tipoNombre.includes('envio') || tipoNombre.includes('env√≠o')) {
      direccionContainer?.classList.remove('hidden');
      if (direccionInput) direccionInput.required = true;
    } else {
      direccionContainer?.classList.add('hidden');
      if (direccionInput) {
        direccionInput.required = false;
        direccionInput.value = '';
      }
    }
  });

  // Renderizar carrito
  function renderCart() {
    const state = $cart.get();
    const cantidad = $cantidadTotal.get();
    const total = $precioTotal.get();

    // Badge
    if (cantidad > 0) {
      cartBadge!.textContent = cantidad.toString();
      cartBadge?.classList.remove('hidden');
    } else {
      cartBadge?.classList.add('hidden');
    }

    // Items
    if (state.items.length === 0) {
      cartItems!.innerHTML = '<p class="text-gray-500 text-center py-8">Tu carrito est√° vac√≠o</p>';
    } else {
      cartItems!.innerHTML = state.items.map(item => `
        <div class="bg-gray-50 rounded-lg p-3 flex items-center gap-3">
          <div class="flex-1">
            <h4 class="font-semibold text-gray-800">${item.nombre}</h4>
            <p class="text-sm text-gray-600">$${item.precio.toFixed(2)} √ó ${item.cantidad}</p>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn-decrease w-8 h-8 border border-gray-300 rounded flex items-center justify-center hover:bg-gray-200" data-id="${item.id}">‚àí</button>
            <span class="font-semibold w-8 text-center">${item.cantidad}</span>
            <button class="btn-increase w-8 h-8 border border-gray-300 rounded flex items-center justify-center hover:bg-gray-200" data-id="${item.id}">+</button>
            <button class="btn-remove w-8 h-8 text-red-600 hover:bg-red-50 rounded flex items-center justify-center" data-id="${item.id}">√ó</button>
          </div>
        </div>
      `).join('');

      // Event listeners para botones
      document.querySelectorAll('.btn-decrease').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt((e.currentTarget as HTMLElement).dataset.id || '0');
          restarItem(id);
        });
      });

      document.querySelectorAll('.btn-increase').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt((e.currentTarget as HTMLElement).dataset.id || '0');
          const item = state.items.find(i => i.id === id);
          if (item) {
            try {
              agregarItem({ id: item.id, nombre: item.nombre, precio: item.precio, stock: item.stock }, item.sucursalId);
            } catch (error) {
              if (error instanceof Error) {
                alert(error.message);
              }
            }
          }
        });
      });

      document.querySelectorAll('.btn-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt((e.currentTarget as HTMLElement).dataset.id || '0');
          eliminarItem(id);
        });
      });
    }

    // Total
    cartTotal!.textContent = `$${total.toFixed(2)}`;
  }

  // Suscribirse a cambios del store
  $cart.subscribe(renderCart);

  // Checkout - Crear pedido y abrir WhatsApp
  checkoutForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const state = $cart.get();
    if (state.items.length === 0) {
      alert('Tu carrito est√° vac√≠o');
      return;
    }

    const formData = new FormData(e.target as HTMLFormElement);
    const nombre = formData.get('nombre') as string;
    const telefono = formData.get('telefono') as string;
    const tipoEntregaValue = formData.get('tipoEntrega') as string;
    const metodoPagoValue = formData.get('metodoPago') as string;
    const direccion = formData.get('direccion') as string;
    const observaciones = formData.get('observaciones') as string;

    // Validar que se hayan seleccionado tipo de entrega y m√©todo de pago
    if (!tipoEntregaValue || tipoEntregaValue === '' || tipoEntregaValue === '0') {
      alert('Por favor selecciona un tipo de entrega');
      return;
    }

    if (!metodoPagoValue || metodoPagoValue === '' || metodoPagoValue === '0') {
      alert('Por favor selecciona un m√©todo de pago');
      return;
    }

    const tipoEntregaId = parseInt(tipoEntregaValue);
    const metodoPagoId = parseInt(metodoPagoValue);

    if (isNaN(tipoEntregaId) || isNaN(metodoPagoId)) {
      alert('Los valores seleccionados no son v√°lidos');
      return;
    }

    // Construir pedido
    const pedido = {
      sucursalId: state.sucursalActiva!,
      nombreCliente: nombre,
      telefonoCliente: telefono,
      direccionCliente: direccion || null,
      tipoEntregaId,
      metodoPagoId,
      observaciones: observaciones || null,
      items: state.items.map(item => ({
        productoId: item.id,
        cantidad: item.cantidad,
      })),
    };


    try {
      const btnConfirmar = document.getElementById('btn-confirmar-pedido') as HTMLButtonElement;
      btnConfirmar.disabled = true;
      btnConfirmar.textContent = 'Enviando...';

      // Crear pedido en el backend
      const response = await crearPedidoPublico(pedido);

      // Construir mensaje de WhatsApp
      const tipoEntregaNombre = tipoEntregaId === 2 ? 'Delivery' : 'Retiro en local';
      const metodoPagoNombre = document.querySelector(`[name="metodoPago"] option:checked`)?.textContent || 'No especificado';
      
      let mensaje = `üçï *Nuevo Pedido - ${sucursalNombre}*%0A%0A`;
      mensaje += `üë§ *Cliente:* ${nombre}%0A`;
      mensaje += `üìû *Tel√©fono:* ${telefono}%0A`;
      mensaje += `üì¶ *Tipo:* ${tipoEntregaNombre}%0A`;
      if (direccion) mensaje += `üìç *Direcci√≥n:* ${direccion}%0A`;
      mensaje += `üí≥ *Pago:* ${metodoPagoNombre}%0A%0A`;
      mensaje += `üõí *Detalle del Pedido:*%0A`;
      state.items.forEach(item => {
        mensaje += `‚Ä¢ ${item.cantidad}x ${item.nombre} - $${(item.precio * item.cantidad).toFixed(2)}%0A`;
      });
      mensaje += `%0Aüí∞ *TOTAL: $${$precioTotal.get().toFixed(2)}*%0A`;
      if (observaciones) mensaje += `%0Aüìù *Observaciones:* ${observaciones}`;
      mensaje += `%0A%0A_Pedido #${response.id}_`;

      // Limpiar carrito
      limpiarCarrito();

      // Abrir WhatsApp
      const whatsappUrl = `https://wa.me/${sucursalTelefono}?text=${mensaje}`;
      window.open(whatsappUrl, '_blank');

      // Cerrar drawer
      closeDrawer();

      // Mostrar mensaje de √©xito
      alert('¬°Pedido enviado! Te redirigimos a WhatsApp para confirmar.');

    } catch (error) {
      console.error('Error al crear pedido:', error);
      alert('Hubo un error al procesar tu pedido. Por favor, intenta de nuevo.');
      const btnConfirmar = document.getElementById('btn-confirmar-pedido') as HTMLButtonElement;
      btnConfirmar.disabled = false;
      btnConfirmar.innerHTML = `
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
        </svg>
        Pedir por WhatsApp
      `;
    }
  });
</script>
