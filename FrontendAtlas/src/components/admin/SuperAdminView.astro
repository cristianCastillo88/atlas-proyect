---
---

<div class="p-6 space-y-6">
  <div class="flex justify-between items-center">
    <div>
      <p class="text-sm text-gray-500">Panel SuperAdmin</p>
      <h1 class="text-3xl font-bold">Negocios Registrados</h1>
    </div>
    <button id="btn-open-negocio" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Nuevo Restaurante</button>
  </div>

  <div class="overflow-x-auto bg-white shadow-sm border border-gray-200 rounded-lg">
    <table class="min-w-full">
      <thead class="bg-gray-50 text-left text-sm font-semibold text-gray-600">
        <tr>
          <th class="px-4 py-3">Nombre</th>
          <th class="px-4 py-3">Dueño</th>
          <th class="px-4 py-3">Sucursales</th>
          <th class="px-4 py-3">Estado</th>
          <th class="px-4 py-3 text-right">Acciones</th>
        </tr>
      </thead>
      <tbody id="tenants-body" class="divide-y divide-gray-200 text-sm"></tbody>
    </table>
  </div>

  <!-- Modal Nuevo Restaurante -->
  <div id="modal-negocio" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative">
      <button id="close-modal-negocio" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">✕</button>
      <h2 class="text-xl font-bold mb-4">Registrar Nuevo Restaurante</h2>
      <form id="form-negocio" class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre del Negocio</label>
          <input name="nombreNegocio" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Dirección Central</label>
          <input name="direccionCentral" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Teléfono</label>
          <input name="telefono" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700">Nombre del Dueño</label>
            <input name="nombreDueno" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" name="email" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" name="password" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancel-negocio" class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Nueva Sucursal -->
  <div id="modal-sucursal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative">
      <button id="close-modal-sucursal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">✕</button>
      <h2 class="text-xl font-bold mb-4">Agregar Sucursal</h2>
      <form id="form-sucursal" class="space-y-3">
        <input type="hidden" name="negocioId" />
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre de la Sucursal</label>
          <input name="nombre" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Dirección</label>
          <input name="direccion" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Teléfono</label>
          <input name="telefono" required class="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancel-sucursal" class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Guardar</button>
        </div>
      </form>
    </div>
  </div>
    <!-- Modal Gestionar Sucursales -->
    <div id="modal-gestionar-sucursales" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 relative">
        <button id="close-modal-gestionar" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">✕</button>
        <h2 class="text-xl font-bold mb-4">Sucursales del Negocio</h2>
        <div id="sucursales-list" class="space-y-2"></div>
      </div>
    </div>
</div>

<script>
  //@ts-nocheck
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:5044';

  function getToken() {
    const store = localStorage.getItem('userStore') || sessionStorage.getItem('userStore');
    if (store) {
      try {
        const parsed = JSON.parse(store);
        return parsed.token ?? null;
      } catch {
        return null;
      }
    }
    return null;
  }

  async function request(path, options = {}) {
    const token = getToken();
    if (!token) throw new Error('No hay token disponible. Inicia sesión nuevamente.');
    const res = await fetch(`${API_URL}${path}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
        ...(options.headers || {}),
      },
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || 'Error en la petición');
    }
    if (res.status === 204) return {};
    return await res.json();
  }

  async function obtenerTodosLosNegocios() {
    return request('/api/admin/tenants');
  }

  async function crearNegocio(payload) {
    const body = {
      nombreNegocio: payload.nombreNegocio,
      direccionCentral: payload.direccionCentral,
      telefono: payload.telefono,
      datosDueno: {
        nombre: payload.nombreDueno,
        email: payload.email,
        password: payload.password,
      },
    };
    console.log('Enviando payload:', body);
    const result = await request('/api/admin/tenants/registrar-negocio', {
      method: 'POST',
      body: JSON.stringify(body),
    });
    console.log('Respuesta:', result);
    return result;
  }

  async function crearSucursal(payload) {
    return request('/api/sucursales', {
      method: 'POST',
      body: JSON.stringify({
        negocioId: payload.negocioId,
        nombre: payload.nombre,
        direccion: payload.direccion,
        telefono: payload.telefono,
      }),
    });
  }

  async function alternarEstadoNegocio(id) {
    return request(`/api/admin/tenants/${id}/toggle-status`, {
      method: 'PATCH',
    });
  }

  async function obtenerSucursalesPorNegocio(negocioId) {
    return request(`/api/sucursales/negocios/${negocioId}`);
  }

  async function alternarEstadoSucursal(id) {
    return request(`/api/sucursales/${id}/toggle-status`, { method: 'PATCH' });
  }

  const tbody = document.getElementById('tenants-body');
  const modalNegocio = document.getElementById('modal-negocio');
  const modalSucursal = document.getElementById('modal-sucursal');
  const modalGestionarSucursales = document.getElementById('modal-gestionar-sucursales');
  const sucursalesList = document.getElementById('sucursales-list');
  const formNegocio = document.getElementById('form-negocio');
  const formSucursal = document.getElementById('form-sucursal');
  const btnOpenNegocio = document.getElementById('btn-open-negocio');
  const closeModalNegocio = document.getElementById('close-modal-negocio');
  const closeModalSucursal = document.getElementById('close-modal-sucursal');
  const cancelNegocio = document.getElementById('cancel-negocio');
  const cancelSucursal = document.getElementById('cancel-sucursal');

  function toggleModal(modal, show) {
    if (!modal) return;
    if (show) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    } else {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }

  async function loadTenants() {
    if (!tbody) return;
    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Cargando...</td></tr>';
    try {
      const data = await obtenerTodosLosNegocios();
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Sin registros</td></tr>';
        return;
      }
      tbody.innerHTML = data
        .map((n) => {
          const estadoClase = n.activo ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
          const estadoTexto = n.activo ? 'Activo' : 'Bloqueado';
          return `
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 font-medium text-gray-900">${n.nombre}</td>
              <td class="px-4 py-3 text-gray-700">${n.dueñoEmail}</td>
              <td class="px-4 py-3 text-gray-700">${n.cantidadSucursales}</td>
              <td class="px-4 py-3">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${estadoClase}">${estadoTexto}</span>
              </td>
              <td class="px-4 py-3 text-right space-x-2">
                <button data-action="toggle" data-id="${n.id}" class="px-3 py-1 rounded-md border text-gray-700 hover:bg-gray-100">${n.activo ? 'Bloquear' : 'Activar'}</button>
                <button data-action="sucursal" data-id="${n.id}" class="px-3 py-1 rounded-md bg-indigo-600 text-white hover:bg-indigo-700">✚ Sucursal</button>
                <button data-action="ver-sucursales" data-id="${n.id}" class="px-3 py-1 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300">Sucursales</button>
              </td>
            </tr>`;
        })
        .join('');
    } catch (err) {
      console.error('Error cargando tenants:', err);
      tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-red-600">Error cargando datos</td></tr>';
    }
  }

  btnOpenNegocio?.addEventListener('click', () => {
    console.log('Opening modal negocio');
    toggleModal(modalNegocio, true);
  });
  closeModalNegocio?.addEventListener('click', () => toggleModal(modalNegocio, false));
  cancelNegocio?.addEventListener('click', () => toggleModal(modalNegocio, false));

  closeModalSucursal?.addEventListener('click', () => toggleModal(modalSucursal, false));
  cancelSucursal?.addEventListener('click', () => toggleModal(modalSucursal, false));
  document.getElementById('close-modal-gestionar')?.addEventListener('click', () => toggleModal(modalGestionarSucursales, false));

  formNegocio?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!formNegocio) return;
    const data = Object.fromEntries(new FormData(formNegocio));
    try {
      await crearNegocio({
        nombreNegocio: String(data.nombreNegocio || ''),
        direccionCentral: String(data.direccionCentral || ''),
        telefono: String(data.telefono || ''),
        nombreDueno: String(data.nombreDueno || ''),
        email: String(data.email || ''),
        password: String(data.password || ''),
      });
      toggleModal(modalNegocio, false);
      formNegocio.reset();
      await loadTenants();
    } catch (err) {
      alert(err instanceof Error ? err.message : 'Error al crear negocio');
    }
  });

  formSucursal?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!formSucursal) return;
    const data = Object.fromEntries(new FormData(formSucursal));
    try {
      await crearSucursal({
        negocioId: Number(data.negocioId),
        nombre: String(data.nombre || ''),
        direccion: String(data.direccion || ''),
        telefono: String(data.telefono || ''),
      });
      toggleModal(modalSucursal, false);
      formSucursal.reset();
      await loadTenants();
    } catch (err) {
      alert(err instanceof Error ? err.message : 'Error al crear sucursal');
    }
  });

  tbody?.addEventListener('click', async (e) => {
    const target = e.target;
    if (!target) return;
    const action = target.getAttribute('data-action');
    const id = target.getAttribute('data-id');
    if (!action || !id) return;

    if (action === 'toggle') {
      try {
        await alternarEstadoNegocio(Number(id));
        await loadTenants();
      } catch (err) {
        alert(err instanceof Error ? err.message : 'Error al actualizar estado');
      }
    }

    if (action === 'sucursal') {
      const inputNegocio = formSucursal?.querySelector('input[name="negocioId"]');
      if (inputNegocio) inputNegocio.value = id;
      toggleModal(modalSucursal, true);
    }

    if (action === 'ver-sucursales') {
      try {
        const items = await obtenerSucursalesPorNegocio(Number(id));
        if (sucursalesList) {
          sucursalesList.innerHTML = items.map((s) => {
            const estadoClase = s.activo ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            const estadoTexto = s.activo ? 'Activa' : 'Inactiva';
            return `<div class="flex items-center justify-between border rounded-md px-3 py-2">
              <div>
                <div class="font-medium text-gray-900">${s.nombre}</div>
                <div class="text-sm text-gray-600">${s.direccion}</div>
              </div>
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${estadoClase}">${estadoTexto}</span>
                <button data-action="toggle-sucursal" data-sucursal-id="${s.id}" class="px-3 py-1 rounded-md border text-gray-700 hover:bg-gray-100">${s.activo ? 'Bloquear' : 'Activar'}</button>
              </div>
            </div>`;
          }).join('');
        }
        // Guardar el negocioId actual en el modal para posibles refrescos
        modalGestionarSucursales?.setAttribute('data-negocio-id', String(id));
        toggleModal(modalGestionarSucursales, true);
      } catch (err) {
        alert(err instanceof Error ? err.message : 'Error al cargar sucursales');
      }
    }
  });

  // Delegación de eventos para botones dentro del modal de gestionar sucursales
  modalGestionarSucursales?.addEventListener('click', async (e) => {
    const target = e.target;
    if (!target) return;
    const action = target.getAttribute('data-action');
    const sucursalId = target.getAttribute('data-sucursal-id');
    if (action === 'toggle-sucursal' && sucursalId) {
      try {
        await alternarEstadoSucursal(Number(sucursalId));
        // Refrescar contenido del modal usando el negocioId guardado
        const negocioIdAttr = modalGestionarSucursales?.getAttribute('data-negocio-id');
        if (negocioIdAttr) {
          const items = await obtenerSucursalesPorNegocio(Number(negocioIdAttr));
          if (sucursalesList) {
            sucursalesList.innerHTML = items.map((s) => {
              const estadoClase = s.activo ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
              const estadoTexto = s.activo ? 'Activa' : 'Inactiva';
              return `<div class="flex items-center justify-between border rounded-md px-3 py-2">
                <div>
                  <div class="font-medium text-gray-900">${s.nombre}</div>
                  <div class="text-sm text-gray-600">${s.direccion}</div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${estadoClase}">${estadoTexto}</span>
                  <button data-action="toggle-sucursal" data-sucursal-id="${s.id}" class="px-3 py-1 rounded-md border text-gray-700 hover:bg-gray-100">${s.activo ? 'Bloquear' : 'Activar'}</button>
                </div>
              </div>`;
            }).join('');
          }
        }
        await loadTenants();
      } catch (err) {
        alert(err instanceof Error ? err.message : 'Error al actualizar estado de la sucursal');
      }
    }
  });

  loadTenants();
  console.log('SuperAdminView initialized', { API_URL, hasToken: !!getToken() });
</script>
